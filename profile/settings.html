<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/tyxar_web/images/tyxar.ico" type="image/x-icon">
    <title>Settings - Tyxar Programming Language</title>
    <link rel="stylesheet" href="/tyxar_web/styles.css">
</head>

<body>

    <!-- SETTINGS PAGE (Full Page) -->
    <div id="settings" class="hidden">
        <!-- Actual site header will be injected here on login -->
        <div id="header"></div>

        <main class="dashboard-main">
            <div class="dashboard-content container">
                <div class="settings-header">
                    <h1>Account Settings</h1>
                    <p>Manage your account information and preferences</p>
                    <a href="/tyxar_web/profile/" class="back-btn">‚Üê Back to Dashboard</a>
                </div>

                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>Profile Information</h3>
                        <form id="profileForm" class="settings-form">
                            <div class="form-group">
                                <label for="settingsName">Full Name</label>
                                <input type="text" id="settingsName" placeholder="Enter your full name" />
                            </div>

                            <div class="form-group">
                                <label for="settingsEmail">Email Address</label>
                                <input type="email" id="settingsEmail" placeholder="Enter your email" readonly />
                                <small class="form-help">Email cannot be changed directly. Contact support if needed.</small>
                            </div>

                            <div class="form-group">
                                <label for="settingsRole">Account Role</label>
                                <input type="text" id="settingsRole" readonly />
                            </div>

                            <div class="form-group">
                                <label for="settingsCreated">Member Since</label>
                                <input type="text" id="settingsCreated" readonly />
                            </div>

                            <button type="submit" class="save-btn">Save Changes</button>
                        </form>
                        <div class="status" id="settingsStatus"></div>
                    </div>

                    <div class="settings-card">
                        <h3>Change Password</h3>
                        <form id="passwordForm" class="settings-form">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" placeholder="Enter current password" />
                            </div>

                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password" />
                            </div>

                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm new password" />
                            </div>

                            <button type="submit" class="save-btn secondary">Update Password</button>
                        </form>
                        <div class="status" id="passwordStatus"></div>
                    </div>

                    <div class="settings-card">
                        <h3>Account Actions</h3>
                        <div class="account-actions">
                            <button onclick="exportData()" class="action-btn">
                                <span>üì§</span>
                                Export My Data
                            </button>
                            <button onclick="deleteAccount()" class="action-btn danger">
                                <span>üóëÔ∏è</span>
                                Delete Account
                            </button>
                        </div>
                        <div class="status" id="actionsStatus"></div>
                    </div>

                    <div class="settings-card">
                        <h3>Preferences</h3>
                        <div class="preferences">
                            <div class="preference-item">
                                <label class="toggle">
                                    <input type="checkbox" id="emailNotifications" />
                                    <span class="toggle-slider"></span>
                                    Email Notifications
                                </label>
                            </div>

                            <div class="preference-item">
                                <label class="toggle">
                                    <input type="checkbox" id="marketingEmails" />
                                    <span class="toggle-slider"></span>
                                    Marketing Emails
                                </label>
                            </div>

                            <div class="preference-item">
                                <label class="toggle">
                                    <input type="checkbox" id="dataCollection" checked />
                                    <span class="toggle-slider"></span>
                                    Analytics & Data Collection
                                </label>
                            </div>
                        </div>
                        <button onclick="savePreferences()" class="save-btn">Save Preferences</button>
                        <div class="status" id="preferencesStatus"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Actual site footer will be injected here on login -->
        <div id="footer"></div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="/tyxar_web/script.js"></script>

    <script>
        // ===============================
        // ELEMENTS
        // ===============================
        const settings = document.getElementById("settings");
        const profileForm = document.getElementById("profileForm");
        const passwordForm = document.getElementById("passwordForm");

        const settingsName = document.getElementById("settingsName");
        const settingsEmail = document.getElementById("settingsEmail");
        const settingsRole = document.getElementById("settingsRole");
        const settingsCreated = document.getElementById("settingsCreated");

        const settingsStatus = document.getElementById("settingsStatus");
        const passwordStatus = document.getElementById("passwordStatus");
        const actionsStatus = document.getElementById("actionsStatus");
        const preferencesStatus = document.getElementById("preferencesStatus");

        // ===============================
        // LOAD USER DATA
        // ===============================
        async function loadUserData() {
            const { data } = await supabaseClient.auth.getUser();
            const user = data.user;

            if (!user) {
                window.location.href = '/tyxar_web/profile/';
                return;
            }

            // Populate form fields
            settingsName.value = user.user_metadata?.full_name || user.user_metadata?.user_name || user.user_metadata?.name || '';
            settingsEmail.value = user.email;
            settingsCreated.value = new Date(user.created_at).toLocaleDateString();

            // Fetch is_admin from profiles table
            const { data: profile } = await supabaseClient
                .from("profiles")
                .select("is_admin")
                .eq("id", user.id)
                .single();

            settingsRole.value = profile?.is_admin ? "Admin" : "User";

            // Show settings page
            settings.classList.remove("hidden");

            // Load header and footer
            loadHeaderFooter();
        }

        // ===============================
        // LOAD HEADER AND FOOTER
        // ===============================
        async function loadHeaderFooter() {
            try {
                const headerResp = await fetch('/tyxar_web/header.html');
                if (headerResp.ok) {
                    const headerHtml = await headerResp.text();
                    document.getElementById('header').innerHTML = headerHtml;
                }
            } catch (e) {
                console.warn('Could not load header:', e);
            }

            try {
                const footerResp = await fetch('/tyxar_web/footer.html');
                if (footerResp.ok) {
                    const footerHtml = await footerResp.text();
                    document.getElementById('footer').innerHTML = footerHtml;
                }
            } catch (e) {
                console.warn('Could not load footer:', e);
            }
        }

        // ===============================
        // FORM HANDLERS
        // ===============================
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = settingsName.value.trim();

            if (!name) {
                settingsStatus.textContent = "Please enter your name.";
                settingsStatus.style.color = "#e53e3e";
                return;
            }

            settingsStatus.textContent = "Updating profile...";

            try {
                const { error } = await supabaseClient.auth.updateUser({
                    data: { full_name: name }
                });

                if (error) throw error;

                settingsStatus.textContent = "Profile updated successfully!";
                settingsStatus.style.color = "#38a169";
            } catch (error) {
                settingsStatus.textContent = error.message;
                settingsStatus.style.color = "#e53e3e";
            }
        });

        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById("currentPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                passwordStatus.textContent = "Please fill in all password fields.";
                passwordStatus.style.color = "#e53e3e";
                return;
            }

            if (newPassword !== confirmPassword) {
                passwordStatus.textContent = "New passwords do not match.";
                passwordStatus.style.color = "#e53e3e";
                return;
            }

            if (newPassword.length < 6) {
                passwordStatus.textContent = "Password must be at least 6 characters.";
                passwordStatus.style.color = "#e53e3e";
                return;
            }

            passwordStatus.textContent = "Updating password...";

            try {
                // First verify current password by attempting sign in
                const { data: user } = await supabaseClient.auth.getUser();
                const { error: signInError } = await supabaseClient.auth.signInWithPassword({
                    email: user.user.email,
                    password: currentPassword
                });

                if (signInError) {
                    throw new Error("Current password is incorrect.");
                }

                // Update password
                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                passwordStatus.textContent = "Password updated successfully!";
                passwordStatus.style.color = "#38a169";

                // Clear form
                document.getElementById("currentPassword").value = "";
                document.getElementById("newPassword").value = "";
                document.getElementById("confirmPassword").value = "";

            } catch (error) {
                passwordStatus.textContent = error.message;
                passwordStatus.style.color = "#e53e3e";
            }
        });

        // ===============================
        // ACCOUNT ACTIONS
        // ===============================
        async function exportData() {
            actionsStatus.textContent = "Preparing data export...";

            try {
                const { data: user } = await supabaseClient.auth.getUser();

                const exportData = {
                    user_id: user.user.id,
                    email: user.user.email,
                    full_name: user.user.user_metadata?.full_name,
                    created_at: user.user.created_at,
                    last_sign_in: user.user.last_sign_in_at,
                    exported_at: new Date().toISOString()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `tyxar-account-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                actionsStatus.textContent = "Data exported successfully!";
                actionsStatus.style.color = "#38a169";

            } catch (error) {
                actionsStatus.textContent = "Failed to export data: " + error.message;
                actionsStatus.style.color = "#e53e3e";
            }
        }

        async function deleteAccount() {
            if (!confirm("Are you sure you want to delete your account? This action cannot be undone.")) {
                return;
            }

            if (!confirm("This will permanently delete all your data. Are you absolutely sure?")) {
                return;
            }

            actionsStatus.textContent = "Deleting account...";

            try {
                const { error } = await supabaseClient.rpc('delete_user_account');

                if (error) throw error;

                await supabaseClient.auth.signOut();
                window.location.href = '/tyxar_web/';

            } catch (error) {
                actionsStatus.textContent = "Failed to delete account: " + error.message;
                actionsStatus.style.color = "#e53e3e";
            }
        }

        // ===============================
        // PREFERENCES
        // ===============================
        async function savePreferences() {
            const preferences = {
                email_notifications: document.getElementById("emailNotifications").checked,
                marketing_emails: document.getElementById("marketingEmails").checked,
                data_collection: document.getElementById("dataCollection").checked
            };

            preferencesStatus.textContent = "Saving preferences...";

            try {
                // Store preferences (you might want to create a preferences table in Supabase)
                localStorage.setItem('tyxar_preferences', JSON.stringify(preferences));

                preferencesStatus.textContent = "Preferences saved!";
                preferencesStatus.style.color = "#38a169";

            } catch (error) {
                preferencesStatus.textContent = "Failed to save preferences.";
                preferencesStatus.style.color = "#e53e3e";
            }
        }

        // ===============================
        // INIT
        // ===============================
        loadUserData();
    </script>

</body>

</html>