<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/tyxar_web/images/tyxar.ico" type="image/x-icon">
    <title>Account - Tyxar Programming Language</title>
    <link rel="stylesheet" href="/tyxar_web/styles.css">
    <style>
    body {
    font-family: system-ui, sans-serif;
    background: #0b0b0b;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    }
    
    .box {
    background: #161616;
    padding: 2rem;
    width: 320px;
    border-radius: 10px;
    }
    
    input,
    button {
    width: 100%;
    margin-top: 0.7rem;
    padding: 0.6rem;
    border-radius: 6px;
    border: none;
    }
    
    input {
    background: #222;
    color: #fff;
    }
    
    button {
    background: #4f46e5;
    color: white;
    cursor: pointer;
    }
    
    button.secondary {
    background: #333;
    }
    
    .hidden {
    display: none;
    }
    
    .status {
    margin-top: 1rem;
    font-size: 0.9rem;
    opacity: 0.85;
    }
    </style>

</head>

<body>

    <div class="box">

        <!-- LOGIN / SIGNUP -->
        <div id="auth">
            <h2>Helix Account</h2>

            <input id="email" type="email" placeholder="Email" />
            <input id="password" type="password" placeholder="Password" />

            <button onclick="login()">Log in</button>
            <button class="secondary" onclick="signup()">Sign up</button>
            <button onclick="loginWithGitHub()" style="background: #24292e; margin-top: 0.5rem;">Login with
                GitHub</button>
            <button onclick="loginWithGoogle()" style="background: #4285f4; color: white; margin-top: 0.5rem;">Login
                with Google</button>

            <div class="status" id="authStatus"></div>
        </div>

        <!-- ACCOUNT -->
        <div id="account" class="hidden">
            <h2>Welcome</h2>

            <p id="userName"></p>
            <p id="userEmail"></p>
            <p id="userRole"></p>
            <p id="userCreated"></p>

            <button onclick="logout()">Log out</button>
        </div>

    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>

    <script>
        // ===============================
        // ELEMENTS
        // ===============================
        const authBox = document.getElementById("auth");
        const accountBox = document.getElementById("account");
        const authStatus = document.getElementById("authStatus");

        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");

        const userEmailText = document.getElementById("userEmail");
        const userRoleText = document.getElementById("userRole");
        const userNameText = document.getElementById("userName");
        const userCreatedText = document.getElementById("userCreated");

        // ===============================
        // AUTH FUNCTIONS
        // ===============================
        async function signup() {
            const email = emailInput.value;
            const password = passwordInput.value;

            const { error } = await supabaseClient.auth.signUp({
                email,
                password
            });

            authStatus.textContent = error
                ? error.message
                : "Check your email to confirm signup.";
        }

        async function login() {
            const email = emailInput.value;
            const password = passwordInput.value;

            const { error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            authStatus.textContent = error
                ? error.message
                : "Logged in.";

            loadUser();
        }

        async function loginWithGitHub() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    redirectTo: 'https://tyxar-lang.github.io/tyxar_web/profile/'
                               }
            });

            authStatus.textContent = error
                ? error.message
                : "Redirecting to GitHub...";
        }

        async function loginWithGoogle() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'https://tyxar-lang.github.io/tyxar_web/profile/'
                               }
            });

            authStatus.textContent = error
                ? error.message
                : "Redirecting to Google...";
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            showAuth();
        }

        // ===============================
        // USER STATE
        // ===============================
        async function loadUser() {
            const { data } = await supabaseClient.auth.getUser();
            const user = data.user;

            if (!user) {
                showAuth();
                return;
            }

            // Display user details
            userNameText.textContent = `Username: ${user.user_metadata?.user_name || user.user_metadata?.name || 'N/A'}`;
            userEmailText.textContent = `Email: ${user.email}`;
            userCreatedText.textContent = `Created: ${new Date(user.created_at).toLocaleDateString()}`;

            // Fetch is_admin from profiles table
            const { data: profile } = await supabaseClient
                .from("profiles")
                .select("is_admin")
                .eq("id", user.id)
                .single();

            userRoleText.textContent =
                profile?.is_admin
                    ? "Role: Admin"
                    : "Role: User";

            authBox.classList.add("hidden");
            accountBox.classList.remove("hidden");
        }

        // ===============================
        // INIT
        // ===============================
        loadUser();

        // ADD THIS - FINAL FIX FOR SHOWING ACCOUNT AFTER OAUTH REDIRECT

        // Clean the #access_token=... from the URL
        if (window.location.hash && window.location.hash.includes('access_token')) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    
        // Force check session and show account after OAuth
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                const { data } = await supabaseClient.auth.getUser();
                const user = data.user;
    
                if (user) {
                    userNameText.textContent = `Username: ${user.user_metadata?.user_name || user.user_metadata?.name || 'N/A'}`;
                    userEmailText.textContent = `Email: ${user.email}`;
                    userCreatedText.textContent = `Created: ${new Date(user.created_at).toLocaleDateString()}`;
    
                    const { data: profile } = await supabaseClient
                        .from("profiles")
                        .select("is_admin")
                        .eq("id", user.id)
                        .single();
    
                    userRoleText.textContent = profile?.is_admin ? "Role: Admin" : "Role: User";
    
                    authBox.classList.add("hidden");
                    accountBox.classList.remove("hidden");
                }
            }
        });
    
        // Also run once in case the session is already there
        (async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                loadUser();  // Reuse your existing loadUser function
            }
        })();
    </script>

    
  

</body>

</html>